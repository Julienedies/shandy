<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>jHandy-股票实时行情监控</title>
    <link rel="stylesheet" href="/css/vendor/bulma/bulma.css"/>
    <link rel="stylesheet" href="/css/basic/0.7/basic.base.css"/>
    <link rel="stylesheet" href="/js/vendor/brick/0.8/css/brick.mobile.css"/>
    <link rel="stylesheet" href="style.css"/>
</head>
<body>

<div>

    <section id="rts" ic-ctrl="rts_ctrl">
        <ul id="rts_list" ic-tpl="list">
            <li ic-for="i,v in model" code="{{v.code}}"
                ic-class="{{(v.warning ? 'warning':'') + ' ' +(v.rout ?'rout':'')}}">
                <div class="flex flex-mc">
                    <span class="code">{{v.code}} </span>
                    <span class="name"> {{v.name}} </span>
                    <span class="b1">{{v.b1/1000}} <i>k</i></span>
                    <span ic-class="b1_reduce {{v.b1_reduce > 0 ? 'up':'down'}}">{{v.b1_reduce}} </span>
                    <span class="increase">{{v.increase}}% </span>
                    <span class="price">{{v.price}} </span>
                    <span class="time"> {{v.time}}</span>
                </div>
                <div class="flex flex-mj">
                    <button class="button" code="{{v.code}}" ic-click="view">查看股票</button>
                    <button class="button" code="{{v.code}}" ic-click="cancel">取消监控</button>
                </div>
            </li>
        </ul>

        <div>
            <button id="tdx_view" code="" ic-click="view">查看股票</button>
            <button id="active_ftnn" ic-click="active_ftnn">激活富途和通达信</button>
            <span id="notify_news" ic-click="notify_news"></span>
        </div>

    </section>

    <footer style="position: fixed;bottom:0; left:0; right:0;" ic-ctrl="help_ctrl">
        <div ic-tpl="links">
            <a class="button is-info" ic-href="http://{{model.ip}}:2018/public/static/html/stock/plan/sell/" target="_blank">平仓预案</a>
            <a class="button is-info" ic-href="http://{{model.ip}}:2018/public/static/html/stock/plan/buy/" target="_blank">建仓条件</a>
            <a class="button is-info" ic-href="http://{{model.ip}}:2018/public/static/html/stock/plan/index/" target="_blank">当前计划</a>
        </div>
    </footer>

</div>

<script src="/js/vendor/underscore.js"></script>
<script src="/js/vendor/jquery.min.js"></script>
<script src="/js/vendor/brick/0.8/brick.mobile.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>

    var channel = 'jhandy';
    var socket = io();
    var $rts = $('#rts');

    function emit(msg) {
        socket.emit(channel, msg);
    }

    socket.on(channel, function (arr) {
        console.log(arr, +new Date);
        $rts.icRender(arr);
    });

    //
    brick.controllers.reg('rts_ctrl', function (scope) {

        scope.cancel = function () {
            let $th = $(this);
            let code = $th.attr('code');
            $th.closest('li').remove();
            emit({event: 'rts_cancel', code: code});
        };

        scope.view = function () {
            let $th = $(this);
            let code = $th.attr('code');
            emit({event: 'view_in_tdx', code: code});
        };

        scope.active_ftnn = function () {
            emit({event: 'active_ftnn'});
        };

        scope.notify_news = function(){
            let msg = $(this).text();
            let d = $(this).data('news');
            console.log(msg, d);
            emit({event:'cls_news', 'news': msg});
        };

    });

    brick.controllers.reg('help_ctrl', function (scope) {
        var ip = location.hostname;
        scope.render('links', {ip: ip});
    });

</script>
</body>
</html>